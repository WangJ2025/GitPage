<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸœ ç¾é£Ÿå¹¸è¿æŠ½å¥–</title>
    <link rel="stylesheet" href="./res/food.css" />
    <script src="./data.js"></script>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸœ ç¾é£Ÿå¹¸è¿æŠ½å¥–</h1>
        <p class="subtitle">ä¸Šä¼ ç¾é£Ÿç…§ç‰‡ï¼Œæœç´¢ç­›é€‰ï¼Œéšæœºå†³å®šä»Šæ™šåƒä»€ä¹ˆï¼</p>
    </header>

    <!-- æœç´¢åŒº -->
    <section class="search-section">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢èœåã€æè¿°æˆ–é£Ÿæï¼ˆå¦‚ï¼šé’æ¤’ã€ç•ªèŒ„ã€è¾£ï¼‰" />
            <button onclick="search()">ğŸ” æœç´¢</button>
            <button onclick="resetSearch()">ğŸ”„ é‡ç½®</button>
        </div>
        <div class="lucky-form">
            <button onclick="doLuckyDraw()">ğŸ²å¼€å§‹æŠ½èœ</button>
            <span>æ¯é¡µæ¡æ•°</span>
            <input type="number" id="pageSize" min="1" max="200" placeholder="ä¸€é¡µå±•ç¤ºå¤šå°‘æ¡" value="12"/>
        </div>
    </section>

    <!-- ç»“æœåˆ—è¡¨ -->
    <section class="results" id="results">
        <div class="loading">æ­£åœ¨åŠ è½½ç¾é£Ÿæ•°æ®...</div>
    </section>

    <!-- åˆ†é¡µ -->
    <div class="pagination" id="pagination"></div>

    <!-- æŠ½å¥–å¼¹çª— -->
    <div class="modal" id="luckyModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <img class="modal-img" id="modalImg" src="" alt="" />
            <h2 class="modal-title" id="modalTitle"></h2>
            <p class="modal-desc" id="modalDesc"></p>
            <div class="modal-meta">
                <span>â­ æ˜Ÿçº§ï¼š<span id="modalStar" class="stars"></span></span>
                <span>ğŸ”¥ éš¾åº¦ï¼š<span id="modalHard" class="hard"></span></span>
            </div>
            <div id="modalFoodIn" style="margin-bottom: 16px;"></div>
            <button onclick="closeModal()" style="padding:10px 24px;">âœ… å…³é—­</button>
        </div>
    </div>

    <footer>
        <p>âœ¨ ç”± GitHub Pages é©±åŠ¨ï½œæ•°æ®å­˜äº data.jsï½œå›¾ç‰‡å­˜äº ./img/</p>
        <p>ğŸ’¡ æ“ä½œæŒ‡å—ï¼šç‚¹é“¾æ¥ â†’ æœ/æŠ½ â†’ ç‚¹å›¾ç‰‡æŸ¥çœ‹è¯¦æƒ… â†’ åŠ æ–°èœï¼Ÿä¸Šä¼ æ–°å›¾ç‰‡+æ›´æ–° data.js å³å¯</p>
    </footer>
</div>

<script>
    // âœ… é…ç½®é¡¹ï¼ˆå¯è½»æ¾ä¿®æ”¹ï¼‰
    const foodLs = shuffleArray([...foodLsOK]);
    let filteredList = [...foodLs]; // åˆå§‹å…¨é‡
    const colPerRow = 4;    // æ¯è¡Œæ˜¾ç¤ºåˆ—æ•°ï¼ˆå½±å“ .results gridï¼‰
    let currentPage = 1;
    function getPageSize(){
        return parseInt(document.getElementById('pageSize').value) || 1;
    }
    function shuffleArray(array) {
        return array.sort(() => Math.random() - 0.5);
    }
    // åˆå§‹åŒ–å‡½æ•°
    function init() {
        // æ•°æ®åŠ è½½æˆåŠŸï¼Œéšè—åŠ è½½æç¤ºå¹¶æ¸²æŸ“å†…å®¹
        renderList();
        renderPagination();
        document.getElementById('searchInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') search();
        });

        // éšè—åŠ è½½æç¤º
        const loadingElement = document.querySelector('.loading');
        if (loadingElement && loadingElement.textContent.includes('æ­£åœ¨åŠ è½½')) {
            loadingElement.style.display = 'none';
        }
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderList() {
        const start = (currentPage - 1) * getPageSize();
        const end = start + getPageSize();
        const pageData = filteredList.slice(start, end);
        const container = document.getElementById('results');

        if (pageData.length === 0) {
            container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¾é£Ÿï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
            return;
        }

        container.innerHTML = pageData.map(item => `
        <div class="food-card" onclick="showDetail('${item.id}')">
          <img class="food-img" src="./img/${item.name}" alt="${item.title}" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMTYwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE2MCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjEwMCIgeT0iODAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2RkZCI+5Zu+54mH5Yqg5oCB5L+h5oWVPC90ZXh0Pjwvc3ZnPg=='" />
          <div class="food-info">
            <div class="food-title">${item.title}</div>
            <div class="food-desc">${item.desc}</div>
            <div class="food-meta">
              <span class="stars">${'â˜…'.repeat(item.star)}${'â˜†'.repeat(5-item.star)}</span>
              <span class="hard">ğŸ”¥${item.hard}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination() {
        const totalPages = Math.ceil(filteredList.length / getPageSize());
        const pagiEl = document.getElementById('pagination');
        if (totalPages <= 1) {
            pagiEl.innerHTML = '';
            return;
        }
        const pages = [];
        for (let i = 1; i <= totalPages; i++) {
            pages.push(`<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="gotoPage(${i})">${i}</button>`);
        }
        pagiEl.innerHTML = pages.join('');
    }

    // æœç´¢
    function search() {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (!q) {
            filteredList = [...foodLs];
        } else {
            filteredList = foodLs.filter(item => {
                const matchTitle = item.title.toLowerCase().includes(q);
                const matchDesc = item.desc.toLowerCase().includes(q);
                const matchFoodIn = item.foodIn.some(f => f.toLowerCase().includes(q));
                return matchTitle || matchDesc || matchFoodIn;
            });
        }
        currentPage = 1;
        renderList();
        renderPagination();
    }

    // é‡ç½®
    function resetSearch() {
        document.getElementById('searchInput').value = '';
        filteredList = [...foodLs];
        currentPage = 1;
        renderList();
        renderPagination();
    }

    // è·³é¡µ
    function gotoPage(page) {
        currentPage = page;
        renderList();
        renderPagination();
    }

    // æŸ¥çœ‹è¯¦æƒ…ï¼ˆç‚¹å‡»å¡ç‰‡ï¼‰
    function showDetail(id) {
        const item = foodLs.find(f => f.id === id);
        if (!item) {
            alert('æ‰¾ä¸åˆ°è¯¥ç¾é£Ÿä¿¡æ¯ï¼');
            return;
        }
        document.getElementById('modalImg').src = `./img/${item.name}`;
        document.getElementById('modalTitle').textContent = item.title;
        document.getElementById('modalDesc').textContent = item.desc;
        document.getElementById('modalStar').textContent = 'â˜…'.repeat(item.star) + 'â˜†'.repeat(5 - item.star);
        document.getElementById('modalHard').textContent = item.hard;
        document.getElementById('modalFoodIn').innerHTML =
            '<strong>æ‰€éœ€é£Ÿæï¼š</strong>' + item.foodIn.join('ã€');
        document.getElementById('luckyModal').classList.add('active');
    }

    // éšæœºæŠ½å¥–
    function doLuckyDraw() {
        if (foodLs.length === 0) {
            alert('è¿˜æ²¡æœ‰ç¾é£Ÿæ•°æ®ï¼Œæ— æ³•æŠ½å¥–ï¼');
            return;
        }

        const count = 1;
        const n = Math.min(Math.max(count, 1), foodLs.length); // ç¡®ä¿åœ¨æœ‰æ•ˆèŒƒå›´å†…

        // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬å¹¶éšæœºæ‰“ä¹±
        const shuffled = [...foodLs].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, n);

        // å¦‚æœåªæŠ½1ä¸ªï¼Œç›´æ¥å±•ç¤ºï¼›å¤šä¸ªåˆ™æ˜¾ç¤ºæ¦‚è§ˆ
        if (n === 1) {
            showDetail(selected[0].id);
        } else {
            alert(`ğŸ‰ å·²éšæœºæŠ½å– ${n} é“èœï¼š\n${selected.map(x => x.title).join('\n')}\n\nï¼ˆç‚¹å‡»ç¡®å®šæŸ¥çœ‹ç¬¬ä¸€é“èœè¯¦æƒ…ï¼‰`);
            // å±•ç¤ºç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤
            showDetail(selected[0].id);
        }
    }

    // å…³é—­å¼¹çª—
    function closeModal() {
        document.getElementById('luckyModal').classList.remove('active');
    }

    // é”®ç›˜å…³é—­å¼¹çª—ï¼ˆESCï¼‰
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
        setTimeout(init, 100);
    });
</script>
</body>
</html>